# afsetools: Agro-Food System and Environment Tools

This package provides coefficients, classifications, and functions for
assessing environmental impacts of agro-food systems and tracing them
through global supply chains.

## Overview

`afsetools` contains:

- **73 data objects**: Biomass coefficients, codes, classifications, and
  conversion factors from harmonized datasets
- **35+ functions**: NPP calculation, impact allocation, supply chain
  tracing, biological N fixation, GHG emissions, and more
- **Workflow functions**: Complete footprint calculation pipelines
- **Standardized visualizations**: Color palettes and plotting themes
  for consistent figures

## Installation

``` r
# Install from GitHub
# install.packages("devtools")
devtools::install_github("eduaguilera/afsetools")
```

## Documentation

**Function Reference**: All functions are documented with roxygen2. You
can read more about the package’s functionalities from the documentation
at the [reference
page](https://eduaguilera.github.io/afsetools/reference/index.html).

After installation, you can also use R’s built-in help system:

``` r
# Get help for any function
?load_general_data
?calculate_footprints
?Calc_NPP_potentials

# See all package functions
help(package = "afsetools")
```

**Data Objects**: For detailed information about the 73+ data objects
loaded by
[`load_general_data()`](https://eduaguilera.github.io/afsetools/reference/load_general_data.md),
see
[DATA_REFERENCE.md](https://eduaguilera.github.io/afsetools/DATA_REFERENCE.md).

## Quick Start

``` r
library(afsetools)

# Load all coefficients and classification data (73 objects)
load_general_data()

# Now you have access to:
# - Biomass_coefs: Conversion factors for DM, N, C, energy
# - GWP: Global warming potentials for greenhouse gases  
# - BNF: Biological nitrogen fixation parameters
# - items_full, regions_full: Harmonized nomenclatures
# - And 60+ more data objects

# Calculate NPP from climate data
npp <- Calc_NPP_potentials(climate_data)

# Calculate crop NPP components
crop_npp <- Calculate_crop_NPP(crop_data, harvest_index)

# Trace impacts through supply chains
# Requires objects in the environment:
# CBS, Primary_all, Impact_prod, Crop_NPPr_NoFallow, Feed_intake,
# Primary_prices, CBS_item_prices, Processing_coefs, Relative_residue_price
# Omit `dtm` for gross trade; pass `dtm = detailed_trade_matrix` for bilateral trade
footprints <- calculate_footprints()

# Access results
primary_fp <- footprints$FP_prim
final_fp <- footprints$FP_final
```

## Main Functions

### Data Loading

- [`load_general_data()`](https://eduaguilera.github.io/afsetools/reference/load_general_data.md):
  Load all 73 coefficient tables and classifications into the
  environment

### NPP Calculation

- `Calc_NPP_potentials()`: Calculate potential NPP using Miami, NCEAS,
  and Rosenzweig models
- `Calculate_crop_NPP()`: Calculate crop NPP components (product,
  residue, root biomass)
- `Calc_NPP_DM_C_N()`: Convert NPP to dry matter, carbon, and nitrogen
- `Calc_CropNPP_components()`: Complete cropland NPP including weed
  biomass

### Impact Tracing

- [`Prepare_prim()`](https://eduaguilera.github.io/afsetools/reference/Prepare_prim.md):
  Prepare primary production data for impact tracing
- [`Allocate_impacts_to_products()`](https://eduaguilera.github.io/afsetools/reference/Allocate_impacts_to_products.md):
  Economic allocation of impacts to co-products
- [`calc_avail_fp_gt()`](https://eduaguilera.github.io/afsetools/reference/calc_avail_fp_gt.md):
  Calculate availability footprint using gross trade
- [`calc_avail_fp_dtm()`](https://eduaguilera.github.io/afsetools/reference/calc_avail_fp_dtm.md):
  Calculate availability footprint using detailed trade matrix
- [`Calc_impact_processed()`](https://eduaguilera.github.io/afsetools/reference/Calc_impact_processed.md):
  Trace impacts through processing chains
- [`Agg_primary()`](https://eduaguilera.github.io/afsetools/reference/Agg_primary.md):
  Aggregate primary products to CBS items
- [`Agg_processed()`](https://eduaguilera.github.io/afsetools/reference/Agg_processed.md):
  Aggregate processed products by origin

### Comprehensive Workflow

- [`calculate_footprints()`](https://eduaguilera.github.io/afsetools/reference/calculate_footprints.md):
  Complete footprint calculation pipeline from primary production to
  final products
- [`extract_luh2()`](https://eduaguilera.github.io/afsetools/reference/extract_luh2.md):
  Extract carbon stock and area data from Land-Use Harmonization 2
  (LUH2) dataset

### Analysis Functions

- [`Calc_N_fix()`](https://eduaguilera.github.io/afsetools/reference/Calc_N_fix.md):
  Calculate biological nitrogen fixation (crop, weed, non-symbiotic)
- [`Gases_GWP()`](https://eduaguilera.github.io/afsetools/reference/Gases_GWP.md):
  Classify GHG emissions and calculate GWP100 CO2 equivalents
- [`Calc_diets()`](https://eduaguilera.github.io/afsetools/reference/Calc_diets.md):
  Calculate nutrient composition of diets
- [`calculate_land_scaling()`](https://eduaguilera.github.io/afsetools/reference/calculate_land_scaling.md):
  Calculate land scaling factors for cropping intensity
- [`scale_land()`](https://eduaguilera.github.io/afsetools/reference/scale_land.md):
  Apply land scaling adjustments

### Utilities

- [`Filling()`](https://eduaguilera.github.io/afsetools/reference/Filling.md),
  [`FillingProxy()`](https://eduaguilera.github.io/afsetools/reference/FillingProxy.md):
  Gap-fill time series data
- `%!in%`: Not-in operator
- [`Arrange_dates()`](https://eduaguilera.github.io/afsetools/reference/Arrange_dates.md):
  Sort data frames by dates
- [`add_xlsx_sheet()`](https://eduaguilera.github.io/afsetools/reference/add_xlsx_sheet.md):
  Add sheets to Excel workbooks

### Visualization

- [`theme_new()`](https://eduaguilera.github.io/afsetools/reference/theme_new.md):
  Clean ggplot2 theme for scientific plots
- [`theme_nolabel()`](https://eduaguilera.github.io/afsetools/reference/theme_nolabel.md):
  Theme without facet labels
- [`ggplotRegression()`](https://eduaguilera.github.io/afsetools/reference/ggplotRegression.md):
  Plot linear regression with statistics

## Package Data

After calling
[`load_general_data()`](https://eduaguilera.github.io/afsetools/reference/load_general_data.md),
you’ll have access to:

**Nomenclatures and Classifications** (35 objects): - `items_full`,
`items_prod_full`, `items_cbs`: Item codes and names - `regions_full`,
`regions_full_uISO3`: Country codes and regional aggregations - `Cats`,
`Cats_proc`: Product categories - `Primary_double`, `Secondary_double`:
Multi-product processes - And 25+ more classification tables

**Biomass Coefficients** (17 objects): - `Biomass_coefs`: Main
coefficient table (DM, N, C, energy content, etc.) - `Root_ref`:
Reference root biomass - `Weed_NPP_Scaling`: Weed biomass scaling
factors - `Residue_Shares`: Crop residue management shares -
`Fallow_cover`: Fallow land cover fractions - And 12+ more coefficient
tables

**Global Warming Potentials** (7 objects): - `GWP`: GWP values for
different gases and time horizons - `GWP_100`: 100-year GWP values - And
5 more GWP-related objects

**Biological N Fixation** (3 objects): - `BNF`: Nitrogen fixation
parameters - `Names_BNF`: BNF nomenclature - `Ndfa_ref`: Reference Ndfa
values

**Constants** (6 scalars): - `Residue_kgC_kgDM_W`, `Root_kgC_kgDM_W`:
Carbon content of weeds - `Residue_kgN_kgDM_W`, `Root_kgN_kgDM_W`:
Nitrogen content of weeds - `Root_Shoot_ratio_W`: Root:shoot ratio for
weeds - `Rhizod_kgN_kgRootN_W`: Rhizodeposition N coefficient

**Color Palettes and Vectors**: - `Total_color`, `SOM_color`,
`GHG_color`, `N_color`, `P_color`, `Land_color`, `Water_color`,
`Energy_color` - `Month_names`, `Month_numbers`: Month utilities

## Data Files

The package bundles standardized input data in `inst/extdata/`:

- `Codes_coefs.xlsx`: 48 sheets with codes, coefficients, and
  classifications
- `Biomass_coefs.xlsx`: Biomass conversion coefficients  
- `BNF.xlsx`: Biological nitrogen fixation parameters
- `GWP.xlsx`: Global warming potentials

These are automatically loaded by
[`load_general_data()`](https://eduaguilera.github.io/afsetools/reference/load_general_data.md).

## Example Workflow

``` r
library(afsetools)
library(dplyr)

# 1. Load all data
load_general_data()

# 2. Prepare your workflow objects in the environment
# (CBS, Primary_all, Impact_prod, Crop_NPPr_NoFallow, Feed_intake,
#  Primary_prices, CBS_item_prices, Processing_coefs, Relative_residue_price)

# 3. Calculate complete footprints
results <- calculate_footprints()

# 4. Analyze results
library(ggplot2)

results$FP_final %>%
  filter(Impact == "GHG", Year == 2020) %>%
  ggplot(aes(x = area, y = Impact_u, fill = Element)) +
  geom_bar(stat = "identity") +
  theme_new() +
  labs(title = "GHG Footprint by Product Group, 2020")
```

## Citation

If you use this package in your research, please cite:

> Aguilera, E., et al. (2025). afsetools: Agro-Food System and
> Environment Tools. R package version 0.1.0.
> <https://github.com/eduaguilera/afsetools>

## Related Repositories

This package provides the foundational tools used by:

- **Spain_Hist**: Historical environmental footprints of Spanish
  agro-food system

## License

MIT © Eduardo Aguilera

## Author

Eduardo Aguilera (<eduardo.aguilera@upm.es>)  
ORCID: [0000-0002-0429-0883](https://orcid.org/0000-0002-0429-0883)

## Contributing

Contributions are welcome! Please see
[CONTRIBUTING.md](https://eduaguilera.github.io/afsetools/CONTRIBUTING.md)
for guidelines.

## Development

To contribute to this package:

``` r
# Clone the repository
git clone https://github.com/eduaguilera/afsetools.git
cd afsetools

# Install development dependencies
devtools::install_dev_deps()

# Run tests
devtools::test()

# Check package
devtools::check()
```

# Package index

## Data Loading

Load coefficients, classifications, and foundational data objects.

- [`load_general_data()`](https://eduaguilera.github.io/afsetools/reference/load_general_data.md)
  : Load General Data, Codes, Coefficients, and Vectors
- [`load_vectors()`](https://eduaguilera.github.io/afsetools/reference/load_vectors.md)
  : Load Color Palettes, Factor Levels, and Categorical Vectors

## NPP Calculation Functions

Net Primary Productivity calculation and conversion functions.

- [`calculate_potential_npp()`](https://eduaguilera.github.io/afsetools/reference/calculate_potential_npp.md)
  : Calculate Potential Net Primary Production (NPP)
- [`calculate_crop_npp()`](https://eduaguilera.github.io/afsetools/reference/calculate_crop_npp.md)
  : Calculate Crop Net Primary Production Components
- [`calculate_npp_dm_c_n()`](https://eduaguilera.github.io/afsetools/reference/calculate_npp_dm_c_n.md)
  : Calculate NPP in Dry Matter, Carbon, and Nitrogen
- [`calculate_crop_npp_components()`](https://eduaguilera.github.io/afsetools/reference/calculate_crop_npp_components.md)
  : Calculate Cropland NPP Components Including Weeds

## Impact Tracing Functions

Supply chain impact allocation and tracing functions.

- [`Prepare_prim()`](https://eduaguilera.github.io/afsetools/reference/Prepare_prim.md)
  : Impact Tracing Functions
- [`Allocate_impacts_to_products()`](https://eduaguilera.github.io/afsetools/reference/Allocate_impacts_to_products.md)
  : Allocate Impacts to Products Based on Economic Value
- [`get_global_export_footprint()`](https://eduaguilera.github.io/afsetools/reference/get_global_export_footprint.md)
  : Get Global Average Export Footprint
- [`calc_avail_fp_gt()`](https://eduaguilera.github.io/afsetools/reference/calc_avail_fp_gt.md)
  : Calculate Available Footprint Using Gross Trade
- [`calc_avail_fp_dtm()`](https://eduaguilera.github.io/afsetools/reference/calc_avail_fp_dtm.md)
  : Calculate Available Footprint Using Detailed Trade Matrix
- [`Calc_impact_processed()`](https://eduaguilera.github.io/afsetools/reference/Calc_impact_processed.md)
  : Calculate Embodied Impact of Processed Products
- [`Agg_primary()`](https://eduaguilera.github.io/afsetools/reference/Agg_primary.md)
  : Aggregate Primary Products to CBS Items
- [`Agg_processed()`](https://eduaguilera.github.io/afsetools/reference/Agg_processed.md)
  : Aggregate Processed Products from Countries to Origins

## Analysis Functions

Specialized environmental impact calculations.

- [`Calc_N_fix()`](https://eduaguilera.github.io/afsetools/reference/Calc_N_fix.md)
  : Biological Nitrogen Fixation Functions
- [`Gases_GWP()`](https://eduaguilera.github.io/afsetools/reference/Gases_GWP.md)
  : Classify GHG Emissions and Calculate Global Warming Potential
- [`Calc_diets()`](https://eduaguilera.github.io/afsetools/reference/Calc_diets.md)
  : Calculate Nutrient Composition of Diets
- [`get_herbwoody_fao()`](https://eduaguilera.github.io/afsetools/reference/get_herbwoody_fao.md)
  : Get Herbaceous and Woody Land from FAO
- [`calculate_land_scaling()`](https://eduaguilera.github.io/afsetools/reference/calculate_land_scaling.md)
  : Calculate Land Scaling Factors
- [`scale_land()`](https://eduaguilera.github.io/afsetools/reference/scale_land.md)
  : Scale Land Area by Cropping Intensity

## Main Workflow Functions

Complete footprint calculation pipelines.

- [`calculate_footprints()`](https://eduaguilera.github.io/afsetools/reference/calculate_footprints.md)
  : Calculate Complete Environmental Footprints Along Supply Chains
- [`extract_luh2()`](https://eduaguilera.github.io/afsetools/reference/extract_luh2.md)
  : Extract Data from Land-Use Harmonization 2 (LUH2) Dataset

## Biomass Processing Functions

Functions for biomass data processing including fallow integration and
residue handling.

- [`biomass_functions`](https://eduaguilera.github.io/afsetools/reference/biomass_functions.md)
  : Biomass Processing Functions
- [`integrate_fallow()`](https://eduaguilera.github.io/afsetools/reference/integrate_fallow.md)
  : Integrate Fallow Area into Cropland Area
- [`residues_as_items()`](https://eduaguilera.github.io/afsetools/reference/residues_as_items.md)
  : Classify Residues as CBS Items
- [`residue_use()`](https://eduaguilera.github.io/afsetools/reference/residue_use.md)
  : Calculate Residue Use from Crop NPP Data

## Utility Functions

Helper functions for data manipulation and gap-filling.

- [`utility_functions`](https://eduaguilera.github.io/afsetools/reference/utility_functions.md)
  : Utility Functions for Data Manipulation
- [`` `%!in%` ``](https://eduaguilera.github.io/afsetools/reference/grapes-not-in-grapes.md)
  : Exclude operator
- [`drop_cols()`](https://eduaguilera.github.io/afsetools/reference/drop_cols.md)
  : Drop columns from data frame
- [`is_empty()`](https://eduaguilera.github.io/afsetools/reference/is_empty.md)
  : Check if dataset is empty
- [`Arrange_dates()`](https://eduaguilera.github.io/afsetools/reference/Arrange_dates.md)
  : Arrange data by dates
- [`add_xlsx_sheet()`](https://eduaguilera.github.io/afsetools/reference/add_xlsx_sheet.md)
  : Add sheet to existing Excel workbook
- [`Filling()`](https://eduaguilera.github.io/afsetools/reference/Filling.md)
  : Fill gaps in time series
- [`FillingProxy()`](https://eduaguilera.github.io/afsetools/reference/FillingProxy.md)
  : Fill gaps using proxy variable
- [`fill_na_with_sum()`](https://eduaguilera.github.io/afsetools/reference/fill_na_with_sum.md)
  : Fill gaps with accumulated sum

## Visualization Functions

Plotting themes and visualization utilities.

- [`theme_new()`](https://eduaguilera.github.io/afsetools/reference/theme_new.md)
  : ggplot2 Themes for Scientific Plots
- [`theme_nolabel()`](https://eduaguilera.github.io/afsetools/reference/theme_nolabel.md)
  : ggplot2 Theme Without Labels
- [`ggplotRegression()`](https://eduaguilera.github.io/afsetools/reference/ggplotRegression.md)
  : Plot Linear Regression with Statistics

## Data Objects

Data objects loaded by load_general_data(). See DATA_REFERENCE.md for
details.

- [`afsetools-data`](https://eduaguilera.github.io/afsetools/reference/afsetools-data.md)
  : Data Objects Loaded by load_general_data()
- [`Biomass_coefs`](https://eduaguilera.github.io/afsetools/reference/Biomass_coefs.md)
  : Biomass Coefficients
- [`GWP`](https://eduaguilera.github.io/afsetools/reference/GWP.md) :
  Global Warming Potentials
- [`BNF`](https://eduaguilera.github.io/afsetools/reference/BNF.md) :
  Biological Nitrogen Fixation Parameters
- [`items_full`](https://eduaguilera.github.io/afsetools/reference/items_full.md)
  : Item Classifications
- [`regions_full`](https://eduaguilera.github.io/afsetools/reference/regions_full.md)
  : Regional Classifications

