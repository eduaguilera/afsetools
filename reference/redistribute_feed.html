<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Redistribute available supply among Livestock_cat based on their demand — redistribute_feed • afsetools</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Redistribute available supply among Livestock_cat based on their demand — redistribute_feed"><meta name="description" content='`redistribute_feed()` matches livestock feed demand to
available feed items through a hierarchical allocation that
follows the remaining-share principle to avoid exceeding
availability.The redistribution path adapts to the
`fixed_demand` column in the demand table.
`fixed_demand = TRUE` uses a six-level hierarchy that
guarantees all demand of each
Livestock_cat-Province_name-Year group is met (by resorting
to provincial grassland), while `fixed_demand = FALSE` uses
a five-level hierarchy that honours observed availability and
can exceed the original demand when supply is abundant.
The modes operate in each year following hierarchy levels in
order:
* **Fixed demand (`fixed_demand = TRUE`)** – six levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Inter-provincial trade of Provincial items, excluding
     those in `Cat_feed == "Grass"`
  5. Substitution within all remaining non-grassland
     availability (provincial then national)
  6. Fulfil any residual demand with unlimited provincial
     grassland
* **Availability-driven (`fixed_demand = FALSE`)** – five
  levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Substitution within all remaining non-grassland
     availability (provincial then national)
  5. Distribute any surplus availability of each `item_cbs`
     across all Year-Province-Livestock demand combinations
     proportionally to their demand, respecting the
     provincial or national nature of the item. Intake can
     exceed the original demand at this stage.
The function relies on the environment objects `items_full`,
`Cats`, and optionally `Monogastric` (character vector of
monogastric livestock categories). Call
`load_general_data()` before using this function.'><meta property="og:description" content='`redistribute_feed()` matches livestock feed demand to
available feed items through a hierarchical allocation that
follows the remaining-share principle to avoid exceeding
availability.The redistribution path adapts to the
`fixed_demand` column in the demand table.
`fixed_demand = TRUE` uses a six-level hierarchy that
guarantees all demand of each
Livestock_cat-Province_name-Year group is met (by resorting
to provincial grassland), while `fixed_demand = FALSE` uses
a five-level hierarchy that honours observed availability and
can exceed the original demand when supply is abundant.
The modes operate in each year following hierarchy levels in
order:
* **Fixed demand (`fixed_demand = TRUE`)** – six levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Inter-provincial trade of Provincial items, excluding
     those in `Cat_feed == "Grass"`
  5. Substitution within all remaining non-grassland
     availability (provincial then national)
  6. Fulfil any residual demand with unlimited provincial
     grassland
* **Availability-driven (`fixed_demand = FALSE`)** – five
  levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Substitution within all remaining non-grassland
     availability (provincial then national)
  5. Distribute any surplus availability of each `item_cbs`
     across all Year-Province-Livestock demand combinations
     proportionally to their demand, respecting the
     provincial or national nature of the item. Intake can
     exceed the original demand at this stage.
The function relies on the environment objects `items_full`,
`Cats`, and optionally `Monogastric` (character vector of
monogastric livestock categories). Call
`load_general_data()` before using this function.'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">afsetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eduaguilera/afsetools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Redistribute available supply among Livestock_cat based on their demand</h1>
      <small class="dont-index">Source: <a href="https://github.com/eduaguilera/afsetools/blob/main/R/feed_distribution_functions.R" class="external-link"><code>R/feed_distribution_functions.R</code></a></small>
      <div class="d-none name"><code>redistribute_feed.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>`redistribute_feed()` matches livestock feed demand to
available feed items through a hierarchical allocation that
follows the remaining-share principle to avoid exceeding
availability.The redistribution path adapts to the
`fixed_demand` column in the demand table.
`fixed_demand = TRUE` uses a six-level hierarchy that
guarantees all demand of each
Livestock_cat-Province_name-Year group is met (by resorting
to provincial grassland), while `fixed_demand = FALSE` uses
a five-level hierarchy that honours observed availability and
can exceed the original demand when supply is abundant.</p>
<p>The modes operate in each year following hierarchy levels in
order:</p>
<p>* **Fixed demand (`fixed_demand = TRUE`)** – six levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Inter-provincial trade of Provincial items, excluding
     those in `Cat_feed == "Grass"`
  5. Substitution within all remaining non-grassland
     availability (provincial then national)
  6. Fulfil any residual demand with unlimited provincial
     grassland</p>
<p>* **Availability-driven (`fixed_demand = FALSE`)** – five
  levels:
  1. Item-level matches (provincial then national)
  2. Substitution within `Cat_1` (prov. then national)
  3. Substitution within `Cat_feed` (prov. then national)
  4. Substitution within all remaining non-grassland
     availability (provincial then national)
  5. Distribute any surplus availability of each `item_cbs`
     across all Year-Province-Livestock demand combinations
     proportionally to their demand, respecting the
     provincial or national nature of the item. Intake can
     exceed the original demand at this stage.</p>
<p>The function relies on the environment objects `items_full`,
`Cats`, and optionally `Monogastric` (character vector of
monogastric livestock categories). Call
`load_general_data()` before using this function.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">redistribute_feed</span><span class="op">(</span></span>
<span>  <span class="va">Feed_demand</span>,</span>
<span>  <span class="va">Feed_avail</span>,</span>
<span>  zoot_fixed_max_multiplier <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  territory_col <span class="op">=</span> <span class="st">"Territory"</span>,</span>
<span>  sub_territory_col <span class="op">=</span> <span class="st">"Sub_territory"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-feed-demand">Feed_demand<a class="anchor" aria-label="anchor" href="#arg-feed-demand"></a></dt>
<dd><p>A data frame with columns `Year`,
`Livestock_cat`, `item_cbs`, `Cat_1`, `Cat_feed`,
`demand_MgDM`, and `fixed_demand` (logical), plus the
user-selected territory columns indicated by
`territory_col` and `sub_territory_col`. The
`fixed_demand` column controls the redistribution mode
row-wise for each demand record, allowing mixed fixed and
availability-driven livestock categories within the same
`Year x Territory` combination.</p></dd>


<dt id="arg-feed-avail">Feed_avail<a class="anchor" aria-label="anchor" href="#arg-feed-avail"></a></dt>
<dd><p>A data frame with columns `Year`,
`item_cbs`, `Cat_1`, `Cat_feed`, `Avail_MgDM`, plus the
user-selected territory columns indicated by
`territory_col` and `sub_territory_col`.
`Feed_scale` is inferred in the function from
`sub_territory_col` (`"Provincial"` when present,
`"National"` otherwise). The table must be
pre-aggregated at the item level.</p></dd>


<dt id="arg-zoot-fixed-max-multiplier">zoot_fixed_max_multiplier<a class="anchor" aria-label="anchor" href="#arg-zoot-fixed-max-multiplier"></a></dt>
<dd><p>Numeric multiplier
(default 3) controlling the maximum ratio of intake to
availability for Zoot_fixed items. When availability of
Zoot_fixed is zero or NA, no cap is applied and intake
equals demand.</p></dd>


<dt id="arg-territory-col">territory_col<a class="anchor" aria-label="anchor" href="#arg-territory-col"></a></dt>
<dd><p>Character scalar indicating the broad
territory column name shared by `Feed_demand` and
`Feed_avail`. Redistribution boundaries are defined by
`Year x territory_col`.</p></dd>


<dt id="arg-sub-territory-col">sub_territory_col<a class="anchor" aria-label="anchor" href="#arg-sub-territory-col"></a></dt>
<dd><p>Character scalar indicating the
local territory column name shared by `Feed_demand` and
`Feed_avail` (e.g., provinces).</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical (default `TRUE`). When `TRUE`,
prints stage-by-stage diagnostic messages. Set to
`FALSE` for silent operation.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A tibble with the columns `Year`, the column named
  by `territory_col`, the column named by
  `sub_territory_col`, `Livestock_cat`, `item_cbs`,
  `Cat_1`, `Cat_feed`, `demand_MgDM`, `intake_MgDM`,
  `scaling_factor`, `hierarchy_level`,
  `original_demand_item`, `original_Province`, and
  `fixed_demand`.</p>
<p>`item_cbs` shows the actual item consumed (from
  availability), while `original_demand_item` shows what
  was originally requested. When substitution occurs, these
  differ. `original_Province` shows the province the feed
  came from (NA for national items). `Cat_1` is appended at
  the end using the lookup table `items_full`, and
  `Cat_feed` using the lookup table `Cats`.</p>
<p>`hierarchy_level` values depend on the redistribution
  mode:</p>
<p>* Fixed demand (`TRUE`):
    1. `"1_item_exact"`
    2. `"2_Cat_1_sub"`
    3. `"3_Cat_feed_sub"`
    4. `"4_inter_prov_trade"`
    5. `"5_all_substitute"`
    6. `"6_grassland_unlimited"`</p>
<p>* Availability-driven (`FALSE`):
    1. `"1_item_exact"`
    2. `"2_Cat_1_sub"`
    3. `"3_Cat_feed_sub"`
    4. `"4_all_substitute"`
    5. `"5_surplus_distribution"`</p>
<p>If both modes are present for any demand records in the
  same run, the function executes the mixed workflow: fixed
  rows can reach `"6_grassland_unlimited"`, while variable
  groups receive surplus allocation.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The allocation follows these rules:</p>
<p>1. Items in `Cat_feed == "Zoot_fixed"` are kept unchanged
   (intake equals demand, even if availability is lower),
   but capped at
   `zoot_fixed_max_multiplier * availability` to prevent
   extreme violations. When availability is zero or NA, no
   cap is applied. If a cap is applied, the excess demand
   should be met through other available items following
   the hierarchy.
2. Monogastric categories are allocated first.
   `Monogastric` is a vector present in the environment
   defining which Livestock_cat are monogastric.
3. Items without a defined `feedtype_graniv` are ignored
   for monogastrics. `feedtype_graniv` is joined from the
   `items_full` lookup table.
4. Ruminant Livestock_cat categories are processed with
   the remaining availability.
5. The availability of each item_cbs is redistributed
   based on demand, respecting the hierarchy levels and
   the provincial/national nature of each item.
6. During levels 1-3, it must be ensured that, if the
   availability of a given feed category is higher than
   the demand, all the demand should be satisfied before
   moving to the next level.
7. During overall redistribution at level 5
   (`fixed_demand=TRUE`) or 4 (`fixed_demand=FALSE`),
   available items are prioritized according to
   `catfeed_priority` (Lactation, High_quality,
   Low_quality, Residues, Grass). This should result in
   all available high-priority feedstuff being allocated
   before lower-priority items are considered.</p>
<p>`original_demand_item` always records the item requested
in the input demand, even when intake is met by a
different item after substitution. The resulting
`scaling_factor` is computed per demand row as
`sum(intake_MgDM) / demand_MgDM`.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://eduaguilera.github.io/afsetools">afsetools</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="load_general_data.html">load_general_data</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Feed_intake</span> <span class="op">&lt;-</span> <span class="fu">redistribute_feed</span><span class="op">(</span></span></span>
<span class="r-in"><span>  Feed_demand <span class="op">=</span> <span class="va">Feed_demand_ygiac</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fixed_demand <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  Feed_avail <span class="op">=</span> <span class="va">Feed_avail_ygi</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-0429-0883" class="external-link">Eduardo Aguilera</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

